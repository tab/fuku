version: 1

x-readiness-log: &readiness-log
  type: log
  pattern: "Service ready"
  timeout: 30s

x-readiness-http: &readiness-http
  type: http
  timeout: 30s
  interval: 500ms

x-readiness-tcp: &readiness-tcp
  type: tcp
  timeout: 30s
  interval: 500ms

x-logs: &logs
  output: [stdout, stderr]

x-watch: &watch
  include:
    - "**/*.go"
    - "**/*.yml"
    - "**/*.yaml"
  ignore:
    - ".git/**"
    - ".idea/**"
    - ".vscode/**"
    - "**/*.swp"
    - "**/*~"
    - "**/.DS_Store"
    - "node_modules/**"
    - "vendor/**"
    - "**/*_test.go"
    - "**/testdata/**"
    - "**/mock_*.go"
    - "**/*_mock.go"
    - "**/bin/**"
    - "**/*.out"
  shared:
    - "examples/bookstore/pkg/common"
  debounce: 1s

services:
  # Foundation tier: Base infrastructure services
  auth:
    dir: examples/bookstore/auth
    tier: foundation
    readiness:
      <<: *readiness-log
    logs:
      <<: *logs
    watch:
      <<: *watch

  storage:
    dir: examples/bookstore/storage
    tier: foundation
    readiness:
      <<: *readiness-log
    watch:
      <<: *watch

  # Platform tier: Business logic services that depend on foundation
  user:
    dir: examples/bookstore/user
    tier: platform
    readiness:
      <<: *readiness-tcp
      address: localhost:9090
    watch:
      <<: *watch

  api:
    dir: examples/bookstore/api
    tier: platform
    readiness:
      <<: *readiness-http
      url: http://localhost:8080/health
    watch:
      <<: *watch

  # Edge tier: Client-facing services
  frontend-api:
    dir: examples/bookstore/frontend-api
    tier: edge
    profiles: [core]
    readiness:
      <<: *readiness-http
      url: http://localhost:8081/health
    watch:
      <<: *watch

defaults:
  profiles: [default]

profiles:
  default: "*"                        # All services
  core: [api, frontend-api, storage]  # Core services for typical development
  minimal: [api, storage]             # Minimal set for lightweight testing

concurrency:
  workers: 10

retry:
  attempts: 5
  backoff: 1s

logs:
  buffer: 500

logging:
  format: console
  level: debug
